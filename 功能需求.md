# 矿场采集 APP 功能需求规则文档

## 1. 总体功能概述

矿场采集 APP 是一款面向矿场工作人员的专业工具，用于矿场采集信息记录，包括拍照及录音。应用支持项目管理、缺陷记录、事件记录和数据统计等功能，并提供离线工作能力，在有网络时同步数据到云端。

## 2. 用户界面与交互

https://modao.cc/app/ASU9llD4sxbbqa4W2jyEO?open_in_browser=true#screen=smbhenzrd8gg7jd

### 2.1 整体导航结构

应用采用底部导航栏设计，包含以下主要导航项：

- 首页/仪表盘
- 项目列表
- 数据同步
- 设置

### 2.2 UI 设计规范

- 遵循 Material Design 设计规范
- 使用统一的颜色主题和字体
- 状态颜色规范：
  - 已完成状态：绿色
  - 离结束日期>5 天：蓝色
  - 离结束日期<5 天>2 天：黄色
  - 离结束日期<2 天：红色

## 3. 功能模块详细规范

### 3.1 首页/仪表盘(Dashboard)

#### 3.1.1 数据概览区域

- **过去 90 天项目统计**

  - 以饼图展示分配给当前用户的项目状态分布
  - 数据来源：本地数据库中的项目数据
  - 交互：点击饼图区域可查看对应状态的项目列表

- **执行中项目统计**
  - 以柱状图展示两类数据：
    1. 历史 Defect 数量与关联了历史 Defect 的 Event 数量
    2. 未关联历史 Defect 的 Event 数量
  - 数据来源：本地数据库中的项目、缺陷和事件数据
  - 交互：点击柱状图区域可查看对应的详细列表

#### 3.1.2 UI 要求

- 顶部显示用户信息和通知图标
- 图表区域使用卡片式设计，有明显的阴影和圆角
- 图表需要有图例说明和数值标注
- 支持下拉刷新更新数据

### 3.2 项目管理模块

#### 3.2.1 项目列表

- **同步功能**

  - 提供同步按钮，点击后从云端同步当前用户相关项目数据
  - 同步过程显示进度条和状态提示
  - 同步完成后显示成功/失败提示

- **列表展示规则**

  - 默认排序："已创建，收集中"状态的 Project 在前，"已完成"状态的 Project 在后
  - 每个项目项显示：
    - 项目名称
    - 项目结束日期
    - 历史 Defect 数量
    - 本次添加的 Event 数量
  - 项目背景颜色根据状态和结束日期显示不同颜色（参照 2.2 中的状态颜色规范）

- **筛选与搜索**
  - 支持按项目状态筛选
  - 支持按项目名称搜索
  - 支持按日期范围筛选

#### 3.2.2 项目详情页

- **顶部概览信息**

  - 显示 Project Description
  - 显示 facility_code、facility_name、facility_location
  - 显示 function_area_code、function_area_name、function_location
  - 提供"查看详情"按钮，点击进入项目基本信息页面

- **快速操作区**

  - 提供"创建 Event"按钮，点击跳转到 Event 详情页面

- **Tab 页切换**
  - 支持在历史 Defect 列表和 Event 列表之间切换
  - 切换时保持各自的滚动位置和筛选条件

### 3.3 缺陷记录模块

#### 3.3.1 历史 Defect 列表

- **列表调整功能**

  - 提供"调整顺序"按钮，点击后进入调整顺序模式
  - 支持上下拖动调整 Defect 位置
  - 调整结果仅保存在当前设备，不与云端同步

- **列表展示规则**

  - 默认只展示 identified、partial repaired、re-assessed 三种状态的 Defect
  - 包括展示类型为 Duty of Care 的 Defect
  - 每个 Defect 项显示：
    - Defect No
    - Risk Rating
    - 关联图片（默认展示前三张，支持左右滑动查看所有图片）
    - 当前设备上关联的 Event 数量

- **交互功能**
  - 支持通过 DefectNo 进行模糊查询
  - 长按 Defect 跳转到 Event 新增页面，自动关联该 Defect
  - 点击 Defect 进入 Defect 详情页面
  - 历史 Duty of care 不能长按跳转新增 Event 页面

#### 3.3.2 Defect 详情页

- 显示 Defect 的详细信息
- 支持查看关联的图片和文档
- 显示关联的 Event 列表

### 3.4 事件记录模块

#### 3.4.1 Event 列表

- **同步模式**

  - 提供"同步模式"按钮，点击后进入同步模式
  - 同步模式下支持选择 Event 上传到云端

- **列表展示规则**

  - 每个 Event 项显示：
    - 可编辑文本框（超出展示区域长度以……结尾）
    - 最后编辑时间
    - 用户编写的 Location 字段
    - 关联的 DefectNo（如有）

- **快速操作按钮**

  - 相机按钮：点击进入拍照模式，支持连续拍照
  - 笔按钮：点击修改 Event 文本框内容
  - 风险评级按钮：点击唤起风险矩阵进行风险评级

- **交互功能**
  - 点击 Event 进入 Event 详情页面

#### 3.4.2 Event 详情页（新增/修改）

- **基本信息编辑**

  - 支持编辑、修改 location 字段
  - 支持编辑、修改文本框内容
  - 支持基于 ObservationTeplate 的选项进行点选
  - 选项点选完成后显示提示："请注意补充 Component Profile 和 Defect Extent 信息"

- **风险评估**

  - 提供风险矩阵功能，进行风险评估
  - 评估结果在页面上显示

- **数字资料管理**

  - 支持唤起数字资料库，多选数字资料关联到 Event
  - 数字资料库支持：
    - 通过数字资源挂载树浏览
    - 通过数字资源名称模糊搜索
  - 图片资料：支持小图预览，点击全屏查看，支持两指缩放
  - PDF 资料：以文字形式展示文件名，点击唤起 PDF 查看器
  - MP3 资料：以文字形式展示文件名，点击直接播放
  - 所有选择的数字资料在 Event 详情页面上展示，支持左右滑动
  - 支持点击右上角小叉叉删除数字资产引用

- **媒体采集功能**

  - 拍照功能：点击照相机唤起相机，支持连续拍照
    - 拍摄的照片在页面上展示，支持左右滑动
    - 支持点击图片全屏查看，全屏后支持两指缩放
    - 支持点击右上角小叉叉删除照片
  - 录音功能：长按麦克风按钮进行录音
    - 录音开始时间与录音时长以列表形式显示
    - 支持点按播放按钮播放音频，再次点击停止播放
    - 支持长按一条录音删除

- **Defect 关联管理**

  - 如已关联历史 Defect，则展示对应的历史 Defect
  - 支持长按历史 Defect 删除关联关系
  - 支持点击历史 Defect 查看历史 Defect 详情
  - 一个 Event 可以关联多个历史 Defect

- **保存与操作**
  - Event 编辑实时保存，无需手动保存
  - 底部提供"同步到云"按钮：点击单独同步当前 Event 到云端
    - 同步成功后，移动端 Event 不再可被用户看到、读写
  - 底部提供"删除 Event"按钮：点击删除当前 Event
  - 离开页面时检测：如当前 Event 没有关联历史 Defect，弹框询问是否需要关联
    - 选择"是"进入 Defect 列表页面，支持多选历史 Defect

### 3.5 数据同步模块

#### 3.5.1 Event 同步到云端

- **网络检测**

  - 进入同步模式时检测网络状态
  - 网络状态不佳时提示用户并退出同步模式

- **同步操作**

  - 支持单选、多选、反选、全选需要同步的 Event
  - 默认选择当前 Event 所在的 Project，支持手动修改
  - 检查上传目标 Project 与上传 Event 关联的 Defect 所属 Project 是否一致
    - 不一致时提示用户

- **同步处理**
  - 拍照结果同步到云端，设置为数字资产
    - 资产名称格式："projectNo+eventId+userCode+PIC+拍照时间"
    - 自动挂载在 Project 下
  - 录音结果同步到云端，设置为数字资产
    - 资产名称格式："projectNo+eventId+userCode+REC+录音时间+录音时长"
    - 自动挂载在 Project 下
  - 采用多次自动重试机制确保同步完整性
  - 支持断点重传同步
  - 同步中断后不影响正常功能使用
  - 同步中断的 Event 在同步成功或失败前不允许更改
  - Event 上传到服务器后，启动异步调度进行录音转文字

### 3.6 存储管理模块

#### 3.6.1 清理存储信息

- **网络检测**

  - 进入清理存储模式时检测网络状态
  - 网络状态不佳时提示用户并退出清理存储模式

- **清理操作**
  - 将已完成状态的 Project 设置为待清理状态并展示
  - 用户选择待清理状态的 Project 进行清理
  - 清理内容包括：关联的数字资产、Event 信息、Defect 信息等
  - 清理数字资产时检查是否被其他 Project 引用
    - 如被进行中状态的 Project 关联，则不删除该数字资产

## 4. 技术要求与约束

### 4.1 离线工作支持

- 应用需支持完全离线工作模式
- 所有操作先保存到本地数据库
- 在有网络时提供数据同步功能

### 4.2 数据存储要求

- 使用 Room 数据库进行本地存储
- 设计合理的数据库结构，支持复杂查询
- 实现高效的数据缓存机制

### 4.3 媒体处理要求

- 支持高质量图片拍摄和存储
- 支持音频录制和播放
- 支持 PDF 文件查看
- 优化媒体文件存储，避免占用过多空间

### 4.4 网络通信要求

- 实现高效的数据同步机制
- 支持断点续传
- 处理网络异常情况
- 确保数据传输安全

### 4.5 性能要求

- 应用启动时间不超过 3 秒
- 列表滚动流畅，无卡顿
- 图片加载响应时间不超过 1 秒
- 后台同步不影响前台操作

## 5. 验收标准

### 5.1 功能验收

- 所有功能模块按需求规范实现
- 用户界面符合设计原型
- 数据同步功能正常工作
- 媒体采集和管理功能正常工作

### 5.2 性能验收

- 满足 4.5 中的性能要求
- 在低配置设备上也能流畅运行
- 内存占用合理，无内存泄漏

### 5.3 兼容性验收

- 支持 Android 12.0 及以上版本
- 适配不同屏幕尺寸和分辨率
- 在主流 Android 设备上测试通过

### 5.4 安全性验收

- 用户数据安全存储
- 网络传输加密
- 敏感操作需要权限验证
